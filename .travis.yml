language: generic
sudo: required
services:
  - docker

branches:
  only:
  - master

before_install:
  - docker build -t felipegutierrez/explore-docker/frontend -f ./frontend/Dockerfile.dev ./frontend
  - docker build -t felipegutierrez/explore-docker/complex -f ./complex/client/Dockerfile.dev ./complex/client

script:
  - docker run -e CI=true felipegutierrez/explore-docker/frontend npm run test -- --coverage
  - docker run -e CI=true felipegutierrez/explore-docker/complex npm run test -- --coverage

after_success:
  - docker build -t felipegutierrez/explore-docker/complex/client ./client
  - docker build -t felipegutierrez/explore-docker/complex/nginx ./nginx
  - docker build -t felipegutierrez/explore-docker/complex/server ./server
  - docker build -t felipegutierrez/explore-docker/complex/worker ./worker
  # Log in to the docker CLI. Log in to docker in a single command line
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # take the images and push them to docker.hub
  - docker push felipegutierrez/explore-docker/complex/client
  - docker push felipegutierrez/explore-docker/complex/nginx
  - docker push felipegutierrez/explore-docker/complex/server
  - docker push felipegutierrez/explore-docker/complex/worker
