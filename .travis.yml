language: generic
sudo: required
env:
  - CHANGE_MINIKUBE_NONE_USER=true
services:
  - docker

branches:
  only:
  - master

before_install:
  - sudo apt-get install -y conntrack
  - docker build -t felipeogutierrez/explore-docker/frontend -f ./frontend/Dockerfile.dev ./frontend
  - docker build -t felipeogutierrez/explore-docker/complex -f ./complex/client/Dockerfile.dev ./complex/client
addons:
  apt:
    update: true

before_script:
  - curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.3/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/
  - curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/
  - sudo minikube start --vm-driver=none --kubernetes-version=v1.18.3
  - minikube update-context
  - JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl get nodes -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1; done

script:
  - docker run -e CI=true felipeogutierrez/explore-docker/frontend npm run test -- --coverage
  - docker run -e CI=true felipeogutierrez/explore-docker/complex npm test

after_success:
  - docker build -t felipeogutierrez/explore-docker-complex-client ./complex/client
  - docker build -t felipeogutierrez/explore-docker-complex-nginx ./complex/nginx
  - docker build -t felipeogutierrez/explore-docker-complex-server ./complex/server
  - docker build -t felipeogutierrez/explore-docker-complex-worker ./complex/worker
  # Log in to the docker CLI. Log in to docker in a single command line
  - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_ID" --password-stdin
  # take the images and push them to docker.hub
  - docker push felipeogutierrez/explore-docker-complex-client
  - docker push felipeogutierrez/explore-docker-complex-nginx
  - docker push felipeogutierrez/explore-docker-complex-server
  - docker push felipeogutierrez/explore-docker-complex-worker
  - kubectl apply -f complex-kubernetes/k8s